{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.name }} - Greeting Card{% endblock %}

{% block header_style %}
<link rel="stylesheet" href="{% static 'css/greeting_card.css' %}">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Interactive greeting card for {{ event.name }}">
{% endblock %}

{% block content %}
<div class="card-container"
     data-theme="{{ event.event_type }}"
     data-cultural-theme="{{ event.cultural_theme|yesno:'true,false' }}"
     data-custom-label="{{ event.custom_label|default:'' }}">
  <div class="card-wrapper">
    <!-- Page indicators -->
    <div class="page-indicator" role="tablist" aria-label="Card Pages">
      <span class="indicator active" data-page="1" role="tab" aria-selected="true" tabindex="0">●</span>
      <span class="indicator" data-page="2" role="tab" aria-selected="false" tabindex="0">○</span>
      <span class="indicator" data-page="3" role="tab" aria-selected="false" tabindex="0">○</span>
      <span class="indicator" data-page="4" role="tab" aria-selected="false" tabindex="0">○</span>
      <span class="indicator" data-page="5" role="tab" aria-selected="false" tabindex="0">○</span>
    </div>

    <!-- Card pages -->
    <div class="card-pages">
      <!-- Page 1: Welcome / Password -->
      <div class="card-page active" id="page-1" role="tabpanel" aria-labelledby="tab-1">
        <div class="diya-container"></div>
        <div class="tree-growth tree-seedling"></div>

        <h2 class="welcome-title" data-event-type="{{ event.event_type }}">
          {% if event.event_type == 'birthday' %}
          Knock knock! It's a special surprise for
          {% elif event.event_type == 'anniversary' %}
          A special note awaits you,
          {% else %}
          A message awaits you,
          {% endif %}
          <span class="recipient-name">{{ event.name }}</span>!
        </h2>

        <div class="puzzle-container">
          {% if event.event_type == 'birthday' %}
          <div class="emoji-puzzle">🎂🎈 = ?</div>
          {% elif event.event_type == 'anniversary' %}
          <div class="date-puzzle">When did we say "I do"?</div>
          {% else %}
          <div class="emoji-puzzle">✈️😢 = ?</div>
          {% endif %}
        </div>

        <div class="password-container">
          <label for="password-input" class="sr-only">Password</label>
          <input type="text" id="password-input" class="password-input" placeholder="Enter the password..." aria-required="true">
          <button class="unlock-button" aria-label="Unlock content">Unlock</button>
          <div class="password-hint" aria-live="polite">
            <span class="hint-icon">💡</span>
            {% if event.event_type == 'birthday' %}
            Hint: The recipient's name might be the key
            {% elif event.event_type == 'anniversary' %}
            Hint: Enter your anniversary date
            {% else %}
            Hint: Think about what this event means to you both
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Page 2: Animation/Countdown -->
      <div class="card-page" id="page-2" role="tabpanel" aria-labelledby="tab-2" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-sapling"></div>

        {% if event.event_type == 'birthday' %}
        <h2 class="page-title">Want a gift, <span class="recipient-name">{{ event.name }}</span>?</h2>
        <div class="countdown-container">
          <div class="countdown" aria-live="assertive">5</div>
          <button class="action-button shake-animation" aria-label="Start countdown">YES!</button>
        </div>
        <div class="gift-reveal hidden" aria-hidden="true">Just kidding... Your card is the gift!</div>

        {% elif event.event_type == 'anniversary' %}
        <h2 class="page-title">Our Journey Together</h2>
        <div class="clock-container">
          <div class="anniversary-clock" aria-label="Anniversary clock showing our journey"></div>
          <div class="milestone-text" aria-live="polite">{{ event.highlights|linebreaksbr }}</div>
          <div class="milestone-text">Every moment with you is special.</div>
        </div>

        {% else %}
        <h2 class="page-title">Memory Flashback</h2>
        <div class="memory-container">
          <div class="memory-frame teal"></div>
          <div class="memory-caption">{{ event.message }}</div>
        </div>
        {% endif %}

        <div class="navigation-buttons">
          <button class="nav-button prev" aria-label="Previous page">Back</button>
          <button class="nav-button next" aria-label="Next page">Next</button>
        </div>
      </div>

      <!-- Page 3: Memory/Media -->
      <div class="card-page" id="page-3" role="tabpanel" aria-labelledby="tab-3" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-young"></div>

        <h2 class="page-title">
          {% if event.event_type == 'birthday' %}Memory Snapshot
          {% elif event.event_type == 'anniversary' %}Our Story
          {% else %}Special Moments
          {% endif %}
        </h2>

        <div class="media-container">
          {% if event.media.exists %}
          <div class="media-display"
               data-media-urls="{% for media in event.media.all %}{{ media.file.url }}{% if not forloop.last %},{% endif %}{% endfor %}"
               tabindex="0">
          </div>
          <div class="media-caption">
            {{ event.media.first.caption|default:"Our special moments" }}
          </div>
          {% else %}
          <div class="placeholder-media"
               aria-label="No media available">
            <div class="placeholder-icon">📷</div>
            <div class="placeholder-text">Memories in our hearts</div>
          </div>
          {% endif %}
        </div>

        <div class="audio-player" aria-label="Audio player">
          <!-- Audio controls will be inserted by JS if audio is available -->
        </div>

        <div class="navigation-buttons">
          <button class="nav-button prev" aria-label="Previous page">Back</button>
          <button class="nav-button next" aria-label="Next page">Next</button>
        </div>
      </div>

      <!-- Page 4: Interactive Element -->
      <div class="card-page" id="page-4" role="tabpanel" aria-labelledby="tab-4" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-mature"></div>

        {% if event.event_type == 'birthday' %}
        <h2 class="page-title">Make a Wish!</h2>
        <div class="cake-container">
          <div class="birthday-cake" tabindex="0" aria-label="Birthday cake with candles. Click to blow out candles.">
            <!-- Cake elements added by JS -->
          </div>
          <div class="cake-instruction" aria-live="polite">Click to blow out the candles!</div>
        </div>
        <div class="quote-container">
          <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
        </div>

        {% elif event.event_type == 'anniversary' %}
        <h2 class="page-title">One More Dance?</h2>
        <div class="dance-container">
          <button class="dance-button" aria-label="Start dance animation">Dance!</button>
          <div class="dance-animation" aria-live="polite"></div>
        </div>
        <div class="quote-container">
          <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
        </div>

        {% else %}
        <h2 class="page-title">Tree of Memories</h2>
        <div class="memory-tree-container">
          <div class="memory-tree" tabindex="0" aria-label="Interactive memory tree. Click to add memories."></div>
          <div class="tree-instruction" aria-live="polite">Click to plant a memory</div>
          <div class="tree-message">
            {{ event.message|default:"Each click represents a moment we've shared." }}
          </div>
        </div>
        <div class="quote-container">
          <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
        </div>
        {% endif %}

        <div class="navigation-buttons">
          <button class="nav-button prev" aria-label="Previous page">Back</button>
          <button class="nav-button next" aria-label="Next page">Next</button>
        </div>
      </div>

      <!-- Page 5: Farewell -->
      <div class="card-page" id="page-5" role="tabpanel" aria-labelledby="tab-5" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-full"></div>

        <h2 class="page-title">
          {% if event.event_type == 'birthday' %}
          Happy Birthday, <span class="recipient-name">{{ event.name }}</span>!
          {% elif event.event_type == 'anniversary' %}
          Here's to us, <span class="recipient-name">{{ event.name }}</span>. Forever yours.
          {% else %}
          <span class="recipient-name">{{ event.name }}</span>, you're unforgettable.
          {% endif %}
        </h2>

        <div class="farewell-message">
          {% if event.message %}
          {{ event.message|linebreaksbr }}
          {% else %}
          Wishing you joy and happiness today and always.
          {% endif %}
        </div>

        {% if event.reflections.exists %}
        <div class="voice-note">
          <div class="voice-note-player">
            <button class="play-voice-note" aria-label="Play reflection note">Play Reflection</button>
            <div class="voice-note-text" aria-live="polite" hidden>{{ event.reflections.first.note }}</div>
          </div>
        </div>
        {% endif %}

        <div class="final-animation" aria-hidden="true"></div>

        <div class="navigation-buttons with-save">
          <button class="nav-button prev" aria-label="Previous page">Back</button>
          <button class="save-button" aria-label="Save memory">🎁 Save this memory!</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card-footer">
    <button class="save-card" aria-label="Save the entire card">📌 Save Card</button>
    <button class="share-card" aria-label="Share card">🔗 Share</button>
  </div>
</div>

<script src="{% static 'js/greeting_card.js' %}"></script>
{% endblock %}