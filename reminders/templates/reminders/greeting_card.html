{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.name }} - Greeting Card{% endblock %}

{% block header_style %}
<link rel="stylesheet" href="{% static 'css/greeting_card.css' %}">
<!--<link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Interactive greeting card for {{ event.name }}">
<style>
  .share-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
  .share-modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center; }
  .share-modal-content input { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
  .share-modal-content button { padding: 8px 16px; margin: 5px; border-radius: 4px; cursor: pointer; }
  .share-url-container { margin-top: 10px; display: none; }
  .social-links a { margin: 0 5px; text-decoration: none; color: #333; }
  .warning-text { color: #d9534f; font-size: 0.9em; margin-bottom: 10px; }


  .feedback-toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; z-index: 1000; }
  .error { border: 2px solid red; }
  .error-message { color: red; }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
  }
</style>
{% endblock %}

{% block content %}
{% if error %}
<div class="error-message" role="alert">{{ error }}</div>
{% endif %}

<div class="card-container"
     data-theme="{{ event.event_type }}"
     data-cultural-theme="{{ event.cultural_theme|yesno:'true,false' }}"
     data-custom-label="{{ event.custom_label|default:'' }}"
     data-event-id="{{ event.id }}">

  <div class="card-wrapper">
    <!-- Page indicators -->
    <div class="page-indicator" role="tablist" aria-label="Card Pages">
      <span class="indicator active" data-page="1" role="tab" aria-selected="true" tabindex="0">‚óè</span>
      <span class="indicator" data-page="2" role="tab" aria-selected="false" tabindex="0">‚óã</span>
      <span class="indicator" data-page="3" role="tab" aria-selected="false" tabindex="0">‚óã</span>
      <span class="indicator" data-page="4" role="tab" aria-selected="false" tabindex="0">‚óã</span>
      <span class="indicator" data-page="5" role="tab" aria-selected="false" tabindex="0">‚óã</span>
    </div>

    <!-- Card pages -->
    <div class="card-pages">
      <!-- Page 1: Welcome / Password -->
      <div class="card-page {% if not requires_card_password %}active{% endif %}" id="page-1" role="tabpanel" aria-labelledby="tab-1">
        <div class="diya-container"></div>
        <div class="tree-growth tree-seedling"></div>

        <h2 class="welcome-title" data-event-type="{{ event.event_type }}">
          {% if event.event_type == 'birthday' %}
          Knock knock! It's a special surprise for
          {% elif event.event_type == 'anniversary' %}
          A special note awaits you,
          {% else %}
          A message awaits you,
          {% endif %}
          <span class="recipient-name">{{ event.name }}</span>!
        </h2>

        <div class="puzzle-container">
          {% if event.event_type == 'birthday' %}
          <div class="emoji-puzzle">üéÇüéà = ?</div>
          {% elif event.event_type == 'anniversary' %}
          <div class="date-puzzle">When did we say "I do"?</div>
          {% else %}
          <div class="emoji-puzzle">‚úàÔ∏èüò¢ = ?</div>
          {% endif %}
        </div>

<!--        {% if requires_card_password %}-->
<!--        <div class="password-container visible">-->
          <form method="post" action="{% url 'validate_card_password' event.id %}">
            {% csrf_token %}
            <label for="card-password-input" class="sr-only">Card Password</label>
            <input type="password" id="card-password-input" name="card_password" class="password-input" placeholder="Enter the card password..." aria-required="true">
            <button type="submit" class="unlock-button" aria-label="Unlock card content">Unlock Card</button>
          </form>
          <div class="password-hint" aria-live="polite">
            <span class="hint-icon">üí°</span>
            Hint: Ask the card creator for the card password
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Page 2: Animation/Countdown -->
      <div class="card-page" id="page-2" role="tabpanel" aria-labelledby="tab-2" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-sapling"></div>

        {% if event.event_type == 'birthday' %}
        <h2 class="page-title">Want a gift, <span class="recipient-name">{{ event.name }}</span>?</h2>
        <div class="countdown-container">
          <div class="countdown" aria-live="assertive">5</div>
          <button class="action-button shake-animation" aria-label="Start countdown">YES!</button>
        </div>
        <div class="gift-reveal hidden" aria-hidden="true">Just kidding... Your card is the gift!</div>

        {% elif event.event_type == 'anniversary' %}
        <h2 class="page-title">Our Journey Together</h2>
        <div class="clock-container">
          <div class="anniversary-clock" aria-label="Anniversary clock showing our journey"></div>
          <div class="milestone-text" aria-live="polite">{{ event.highlights|linebreaksbr }}</div>
          <div class="milestone-text">Every moment with you is special.</div>
        </div>

        {% else %}
        <h2 class="page-title">Memory Flashback</h2>
        <div class="memory-container">
          <div class="memory-frame teal"></div>
          <div class="memory-caption">{{ event.message }}</div>
        </div>
        {% endif %}

        <div class="navigation-buttons">
          <button class="nav-button prev" aria-label="Previous page">Back</button>
          <button class="nav-button next" aria-label="Next page">Next</button>
        </div>
      </div>

        <!-- Page 3: Memory/Media -->
        <div class="card-page active" id="page-3" role="tabpanel" aria-labelledby="tab-3">
            <div class="diya-container"></div>
            <div class="tree-growth tree-young"></div>

            <h2 class="page-title">
                {% if event.event_type == 'birthday' %}Memory Snapshot
                {% elif event.event_type == 'anniversary' %}Our Story
                {% else %}Special Moments
                {% endif %}
            </h2>

            <div class="media-container">
                <div class="media-display"
                     data-media-urls="{% for media in event.media.all %}{% if media.media_type == 'image' %}{{ media.media_file|urlencode }}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}"
                     data-fallback-url="{% static 'images/nature.jpg' %}"
                     tabindex="0">
                </div>

                <div class="media-caption">
                    {% if event.media.exists %}
                        {{ event.media.first.caption|default:"Our special moments" }}
                    {% else %}
                        A moment inspired by nature
                    {% endif %}
                </div>

                {% if event.media.all|length > 1 %}
                    <div class="slideshow-controls">
                        <button class="slideshow-btn prev" aria-label="Previous image">‚Üê</button>
                        <div class="slideshow-indicators"></div>
                        <button class="slideshow-btn next" aria-label="Next image">‚Üí</button>
                    </div>
                {% endif %}

                <!-- üéµ Calming Background Audio -->
                <audio id="calming-sound" loop>
                    <source src="{% static 'audio/Whispering Wind.mp3' %}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>

                <!-- üéõÔ∏è Audio Control Button -->
                <button class="audio-control" aria-label="Toggle calming sound">Pause Sound</button>
            </div>

            <div class="navigation-buttons">
                <button class="nav-button prev" aria-label="Previous page">Back</button>
                <button class="nav-button next" aria-label="Next page">Next</button>
            </div>
        </div>

      <!-- Page 4: Interactive Element -->
      <div class="card-page" id="page-4" role="tabpanel" aria-labelledby="tab-4" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-mature"></div>

        {% if event.event_type == 'birthday' %}
        <h2 class="page-title">Make a Wish!</h2>
        <div class="cake-container">
          <div class="birthday-cake" tabindex="0" aria-label="Birthday cake with candles. Click to blow out candles."></div>
          <div class="cake-instruction" aria-live="polite">Click to blow out the candles!</div>
        </div>
        <div class="quote-container">
          <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
        </div>

        {% elif event.event_type == 'anniversary' %}
        <h2 class="page-title">One More Dance?</h2>
        <div class="dance-container">
          <button class="dance-button" aria-label="Start dance animation">Dance!</button>
          <div class="dance-animation" aria-live="polite"></div>
        </div>
        <div class="quote-container">
          <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
        </div>

        {% else %}
        <h2 class="page-title">Tree of Memories</h2>
        <div class="memory-tree-container">
          <div class="memory-tree" tabindex="0" aria-label="Interactive memory tree. Click to add memories."></div>
          <div class="tree-instruction" aria-live="polite">Click to plant a memory</div>
          <div class="tree-message">
            {{ event.message|default:"Each click represents a moment we've shared." }}
          </div>
        </div>
        <div class="quote-container">
          <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
        </div>
        {% endif %}

        <div class="navigation-buttons">
          <button class="nav-button prev" aria-label="Previous page">Back</button>
          <button class="nav-button next" aria-label="Next page">Next</button>
        </div>
      </div>

      <!-- Page 5: Farewell -->
      <div class="card-page" id="page-5" role="tabpanel" aria-labelledby="tab-5" aria-hidden="true">
        <div class="diya-container"></div>
        <div class="tree-growth tree-full"></div>

        <h2 class="page-title">
          {% if event.event_type == 'birthday' %}
          Happy Birthday, <span class="recipient-name">{{ event.name }}</span>!
          {% elif event.event_type == 'anniversary' %}
          Here's to us, <span class="recipient-name">{{ event.name }}</span>. Forever yours.
          {% else %}
          <span class="recipient-name">{{ event.name }}</span>, you're unforgettable.
          {% endif %}
        </h2>

        <div class="farewell-message">
          {% if event.message %}
          {{ event.message|linebreaksbr }}
          {% else %}
          Wishing you joy and happiness today and always.
          {% endif %}
        </div>

        {% if event.reflections.exists %}
        <div class="voice-note">
          <div class="voice-note-player">
            <button class="play-voice-note" aria-label="Play reflection note">Play Reflection</button>
            <div class="voice-note-text" aria-live="polite" hidden>{{ event.reflections.first.note }}</div>
          </div>
        </div>
        {% endif %}

        <div class="final-animation" aria-hidden="true"></div>

<!--        <div class="navigation-buttons with-save">-->
<!--          <button class="nav-button prev" aria-label="Previous page">Back</button>-->
<!--          <button class="save-button" aria-label="Save memory">üéÅ Save this memory!</button>-->
<!--        </div>-->
      </div>
    </div>
  </div>

  <div class="card-footer">
    {% if is_owner %}
<!--    <button class="save-card" aria-label="Save the entire card">üìå Save Card</button>-->
    <button class="share-card" data-event-id="{{ event.id }}" aria-label="Share card">üîó Share</button>
    {% endif %}
  </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="share-modal">
    <div class="share-modal-content">
        <h3>Share Your Card</h3>
        <p class="warning-text">Warning: This link will expire in 3 days.</p>
        <form id="share-form" onsubmit="return false;"> <!-- Prevent default submission -->
            {% csrf_token %}
            <input type="password" id="share-password" name="share_password" placeholder="Set a share password (optional)..." aria-required="false">
            <div>
                <button type="button" id="generate-share-link" aria-label="Generate share link">Generate Link</button>
                <button type="button" id="close-share-modal" aria-label="Close modal">Cancel</button>
            </div>
        </form>
        <div class="share-url-container" id="share-url-container">
            <p id="share-url"></p>
            <div class="social-links">
                <a id="whatsapp-share" href="#" target="_blank" aria-label="Share on WhatsApp">WhatsApp</a>
                <a id="twitter-share" href="#" target="_blank" aria-label="Share on Twitter">Twitter</a>
                <a id="email-share" href="#" aria-label="Share via Email">Email</a>
            </div>
        </div>
    </div>
</div>

<script>
  document.cookie = "csrftoken={{ csrf_token }}; path=/";
</script>
<script src="{% static 'js/greeting_card.js' %}"></script>
{% endblock %}