{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Event{% else %}Add Event{% endif %}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto card p-8 mt-8">
    <h2 class="text-2xl font-bold mb-6">
        {% if form.instance.pk %}Edit Event{% else %}Add New Event{% endif %}
    </h2>
    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="bg-red-100 text-red-700 p-3 rounded mb-4">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="mb-4">
            <label for="{{ form.name.id_for_label }}" class="block font-semibold mb-1">Name</label>
            {{ form.name }}
            {% if form.name.errors %}
                <div class="text-red-600 text-sm">{{ form.name.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="{{ form.event_type.id_for_label }}" class="block font-semibold mb-1">Event Type</label>
            {{ form.event_type }}
            {% if form.event_type.errors %}
                <div class="text-red-600 text-sm">{{ form.event_type.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4" id="recurring-field" style="display: none;">
            <label for="{{ form.is_recurring.id_for_label }}" class="block font-semibold mb-1">
                <input type="checkbox" id="{{ form.is_recurring.id_for_label }}" name="{{ form.is_recurring.name }}" {% if form.is_recurring.value %}checked{% endif %}>
                Recurring Annually
            </label>
            {% if form.is_recurring.errors %}
                <div class="text-red-600 text-sm">{{ form.is_recurring.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4" id="custom-label-field" >
            <label for="{{ form.custom_label.id_for_label }}" class="block font-semibold mb-1">Custom Label</label>
            {{ form.custom_label }}
            {% if form.custom_label.errors %}
                <div class="text itext-red-600 text-sm">{{ form.custom_label.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="{{ form.date.id_for_label }}" class="block font-semibold mb-1">Date</label>
            {{ form.date }}
            {% if form.date.errors %}
                <div class="text-red-600 text-sm">{{ form.date.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="{{ form.remind_days_before.id_for_label }}" class="block font-semibold mb-1">Remind Days Before</label>
            {{ form.remind_days_before }}
            {% if form.remind_days_before.errors %}
                <div class="text-red-600 text-sm">{{ form.remind_days_before.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="{{ form.message.id_for_label }}" class="block font-semibold mb-1">Message</label>
            {{ form.message }}
            {% if form.message.errors %}
                <div class="text-red-600 text-sm">{{ form.message.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="{{ form.cultural_theme.id_for_label }}" class="block font-semibold mb-1">Cultural Theme</label>
            {{ form.cultural_theme }}
            {% if form.cultural_theme.errors %}
                <div class="text-red-600 text-sm">{{ form.cultural_theme.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="{{ form.highlights.id_for_label }}" class="block font-semibold mb-1">Milestones / Highlights</label>
            {{ form.highlights }}
            {% if form.highlights.errors %}
                <div class="text-red-600 text-sm">{{ form.highlights.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label for="id_media_files" class="block font-semibold mb-1">Media Files (max 3)</label>
            <input
                type="file"
                name="media_files"
                id="id_media_files"
                accept=".jpg,.jpeg,.png,.mp3,.wav,.flac"
                multiple
                class="mt-1 block w-full"
            >
            <p class="text-sm text-gray-500">Max 50MB for images, 10MB for audio. Allowed: .jpg, .jpeg, .png, .mp3, .wav, .flac</p>
            <div id="media-preview" class="flex gap-4 mt-2"></div>
            {% if form.instance.pk and form.instance.media.exists %}
                <p class="text-gray-600 mt-2 font-semibold">Current Media:</p>
                <div class="flex flex-wrap gap-4">
                    {% for media in form.instance.media.all %}
                        <div class="border rounded p-2 shadow-sm max-w-xs">
                            {% if media.media_type == 'image' %}
                                <img src="{{ media.media_file.url }}" alt="Event Image" class="max-w-xs rounded-lg shadow-md">
                                <a href="{{ media.media_file.url }}" download class="block mt-2 text-blue-600 hover:underline">Download Image</a>
                            {% elif media.media_type == 'audio' %}
                                <audio controls class="w-full">
                                    <source src="{{ media.media_file.url }}" type="{{ media.mime_type }}">
                                    Your browser does not support the audio element.
                                </audio>
                                <a href="{{ media.media_file.url }}" download class="block mt-2 text-blue-600 hover:underline">Download Audio</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="flex justify-end gap-4 mt-8">
            <a href="{% url 'event_list' %}" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800">Cancel</a>
            <button type="submit" class="px-6 py-2 rounded bg-purple-600 text-white font-semibold hover:bg-purple-700 shadow">Save Event</button>
        </div>
    </form>
</div>
<script src="{% static 'js/event_form.js' %}"></script>
{% endblock %}